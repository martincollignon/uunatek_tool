<!DOCTYPE html>
<html>
<head>
  <title>Test Tauri Serial</title>
  <script type="module">
    window.addEventListener('DOMContentLoaded', async () => {
      const log = document.getElementById('log');
      const testBtn = document.getElementById('testBtn');

      function logMessage(msg) {
        console.log(msg);
        log.innerHTML += msg + '\n';
      }

      testBtn.addEventListener('click', async () => {
        try {
          logMessage('[Test] Importing Tauri serial plugin...');
          const { SerialPort } = await import('tauri-plugin-serialplugin');

          logMessage('[Test] Listing ports...');
          const ports = await SerialPort.available_ports_direct();
          logMessage(`[Test] Found ${Object.keys(ports).length} ports:`);

          for (const [path, info] of Object.entries(ports)) {
            logMessage(`  ${path}: VID=${info.vid?.toString(16)}, PID=${info.pid?.toString(16)}`);
          }

          // Find plotter port
          const plotterPath = Object.keys(ports).find(p => p.includes('usbmodem'));
          if (!plotterPath) {
            logMessage('[Test] ERROR: No plotter port found!');
            return;
          }

          logMessage(`\n[Test] Attempting to open ${plotterPath}...`);
          await SerialPort.open(plotterPath, 115200, 8, 'None', 'None', 1, 1000);
          logMessage('[Test] ✓ Port opened successfully!');

          // Try to write a command
          logMessage('[Test] Sending status query (?)...');
          const written = await SerialPort.write(plotterPath, '?');
          logMessage(`[Test] Wrote ${written} bytes`);

          // Try to read response
          logMessage('[Test] Reading response...');
          const response = await SerialPort.read(plotterPath, 2000, 1024);
          logMessage(`[Test] Received: ${response}`);

          // Close port
          logMessage('[Test] Closing port...');
          await SerialPort.close(plotterPath);
          logMessage('[Test] ✓ Port closed');

          logMessage('\n[Test] ✓ ALL TESTS PASSED!');

        } catch (error) {
          logMessage(`[Test] ✗ ERROR: ${error.message}`);
          console.error(error);
        }
      });
    });
  </script>
</head>
<body>
  <h1>Tauri Serial Port Test</h1>
  <button id="testBtn">Run Test</button>
  <pre id="log" style="background: #f0f0f0; padding: 10px; margin-top: 20px; font-family: monospace;"></pre>
</body>
</html>
